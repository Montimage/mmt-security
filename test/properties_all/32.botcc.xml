<beginning>
<embedded_functions><![CDATA[
#define _GNU_SOURCE
#include "hash_table_ipadd.h"

static inline int em_check_botnetcc(const char *ipsrc, const char *ipdst){
	int handle = 0;
	
	//extract ip_src, ip_dst
   	char *ip_src = (char *)malloc(sizeof(char)*16);
   	char *ip_dst = (char *)malloc(sizeof(char)*16);
        sprintf(ip_src,"%d.%d.%d.%d", (unsigned char)ipsrc[0], (unsigned char)ipsrc[1], (unsigned char)ipsrc[2], (unsigned char)ipsrc[3]);
        ip_src[15]='\0';
   	sprintf(ip_dst,"%d.%d.%d.%d", (unsigned char)ipdst[0], (unsigned char)ipdst[1], (unsigned char)ipdst[2], (unsigned char)ipdst[3]);
   	ip_dst[15]='\0';	
	
	//Look up in hash tables
	if((search_hash_ip(ipStr2DataItem(ip_src)->key) != NULL) || (search_hash_ip(ipStr2DataItem(ip_dst)->key) != NULL)) handle = 1;
	
        //free everything before quitting
        free(ip_src);
        free(ip_dst);
        return handle;
}
]]></embedded_functions>
<!-- Property 32: Botnet Command and Control detection based on blacklisted IP addresses. 
This rule replaces 299 Suricata rules and covers 12835 blacklisted IP addr. 
NOTE: MMT_Security must run with -b option 
-->
<property value="THEN" delay_units="ms" delay_min="0" delay_max="0" property_id="32" type_property="ATTACK" 
    description="Botnet Command and Control detection"
    >
   <event value="COMPUTE" event_id="1" 
           description="IP source or IP destination is a bot"
           boolean_expression="(#em_check_botnetcc(ip.src, ip.dst) == 1)"/>
    <event value="COMPUTE" event_id="2" 
           description="IP packet"
           boolean_expression="(ip.src != ip.dst)"/>
</property>
</beginning>


